<!DOCTYPE html>
<html>
<head>
    <title>YouTube to MP3</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .note { font-size: 0.9rem; color: #666; }
        #status { margin-top: 15px; font-size: 1rem; }
        .spinner-border { width: 1.5rem; height: 1.5rem; vertical-align: middle; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">ðŸŽµ YouTube to MP3</h1>
    <form id="downloadForm">
        <div class="mb-3">
            <label for="youtube_urls" class="form-label">YouTube Link(s)</label>
            <textarea id="youtube_urls" name="youtube_urls" class="form-control" rows="6" placeholder="Paste one link per line"></textarea>
            <div class="note mt-1">Supports single videos, multiple links. Downloads start one-by-one.</div>
        </div>
        <button type="submit" class="btn btn-primary">Start Download</button>
    </form>

    <div id="status" class="mt-3"></div>
</div>

<script>
document.getElementById('downloadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const statusDiv = document.getElementById('status');
    const textareaValue = document.getElementById('youtube_urls').value.trim();
    if (!textareaValue) {
        alert('Please paste a YouTube link or playlist.');
        return;
    }

    statusDiv.innerHTML = `<div><span class="spinner-border"></span> Fetching video list...</div>`;

    // Send first URL or the first line to /get_urls
    const formData = new URLSearchParams();
    formData.append('youtube_url', textareaValue.split('\n')[0]);

    const res = await fetch('/get_urls', { method: 'POST', body: formData });
    const data = await res.json();
    if (!data.urls || data.urls.length === 0) {
        statusDiv.innerHTML = `<div class="text-danger">No videos found.</div>`;
        return;
    }

    // If user pasted multiple URLs, merge with playlist extraction
    const manualUrls = textareaValue.split('\n').map(u => u.trim()).filter(Boolean);
    const finalUrls = [...new Set([...manualUrls, ...data.urls])]; // remove duplicates

    statusDiv.innerHTML = `<div>Found ${finalUrls.length} video(s). Starting downloads...</div>`;

    // Download one-by-one
    for (let i = 0; i < finalUrls.length; i++) {
        const url = finalUrls[i];
        statusDiv.innerHTML = `<div><span class="spinner-border"></span> Downloading ${i+1} of ${finalUrls.length}...</div>`;

        const dlForm = new FormData();
        dlForm.append('youtube_url', url);

        const resp = await fetch('/download', { method: 'POST', body: dlForm });
        if (resp.ok) {
            const blob = await resp.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);

            let filename = resp.headers.get('Content-Disposition');
            filename = filename ? filename.split('filename=')[1]?.replace(/"/g, '') : `track${i+1}.mp3`;

            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
        } else {
            console.error('Failed to download:', url);
        }
    }

    statusDiv.innerHTML = `<div class="text-success">âœ… All downloads completed.</div>`;
});
</script>
</body>
</html>
